
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Veterinaria a Domicilio - Agenda tu Visita</title>
  <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@700&family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <!-- EmailJS para envÃ­o automÃ¡tico de emails -->
  <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
  <style>
    :root {
      --primary: #4a7c59;
      --primary-dark: #3a5f45;
      --secondary: #f4a261;
      --accent: #e76f51;
      --bg-light: #faf8f3;
      --bg-cream: #f5efe6;
      --text-dark: #2d3436;
      --text-light: #636e72;
      --shadow: rgba(74, 124, 89, 0.15);
      --shadow-strong: rgba(74, 124, 89, 0.3);
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Quicksand', sans-serif;
      background: linear-gradient(135deg, var(--bg-light) 0%, var(--bg-cream) 100%);
      color: var(--text-dark);
      min-height: 100vh; overflow-x: hidden;
    }
    /* ... (se mantienen tus estilos originales sin cambios) ... */
    .time-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(110px,1fr)); gap:10px; margin-top:10px; }
    .time-slot { padding:12px; background:var(--bg-cream); border:2px solid var(--primary); border-radius:10px; cursor:pointer; text-align:center; font-weight:600; transition:all .3s ease; }
    .time-slot:hover { background:var(--primary); color:#fff; transform:scale(1.05); }
    .time-slot.selected { background:var(--primary); color:#fff; box-shadow:0 4px 15px var(--shadow-strong); }
    .time-slot.unavailable { background:#f0f0f0; border-color:#ccc; color:#999; cursor:not-allowed; opacity:.5; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px;flex-wrap:wrap;">
        <img id="logoManadaPatitas" src="" alt="Manada Patitas" style="height:80px;animation:bounce 2s ease-in-out infinite;" />
        <div style="text-align:left;">
          <h1 style="margin:0;">Manada Patitas</h1>
          <p style="font-size:1.1rem;color:var(--secondary);font-weight:600;margin:5px 0 0 0;">Veterinaria a Domicilio</p>
        </div>
      </div>
      <p class="subtitle">Cuidado profesional para tu mascota en la comodidad de tu hogar</p>
      <a href="#" id="instagramLink" class="instagram-link" target="_blank">ğŸ“± SÃ­guenos en Instagram</a>
    </header>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('servicios')">ğŸ’° Servicios</button>
      <button class="tab" onclick="switchTab('agendar')">ğŸ“… Agendar</button>
      <button class="tab" onclick="switchTab('citas')">ğŸ“‹ Mis Citas</button>
      <button class="tab" onclick="switchTab('admin')"><span class="lock-icon">ğŸ”’</span> Config</button>
    </div>

    <!-- TAB: SERVICIOS -->
    <div id="servicios" class="tab-content active">
      <!-- (contenido de servicios igual al original) -->
      <div class="whatsapp-footer">
        <h3>Â¿Tu peludito necesita un chequeo?</h3>
        <p>Â¡Evita el estrÃ©s de los traslados y las salas de espera!</p>
        <p style="margin-top:15px;">ğŸ“± Agenda tu cita al WhatsApp:</p>
        <p><strong id="whatsappDisplay">+(56) 9 9540 9035</strong></p>
        <p style="margin-top:10px;">ğŸ“§ O escrÃ­benos al email:</p>
        <p><strong id="emailDisplay">contacto@manadapatitas.cl</strong></p>
      </div>
      <button class="primary" style="margin-top:20px;" onclick="switchTab('agendar')">ğŸ“… Agendar mi visita ahora</button>
    </div>

    <!-- TAB: AGENDAR -->
    <div id="agendar" class="tab-content">
      <div class="card">
        <h2 style="margin-bottom:25px;color:var(--primary);font-family:'Caveat',cursive;font-size:2rem;">Agenda tu Visita</h2>
        <form id="appointmentForm">
          <div class="form-group"><label>ğŸ‘¤ Nombre del dueÃ±o/a</label><input type="text" id="ownerName" required placeholder="Tu nombre completo" /></div>
          <div class="form-group"><label>ğŸ• Nombre de la mascota</label><input type="text" id="petName" required placeholder="Nombre de tu mascota" /></div>
          <div class="form-group"><label>ğŸ“ TelÃ©fono de contacto</label><input type="tel" id="phone" required placeholder="569XXXXXXXX" /></div>
          <div class="form-group"><label>ğŸ“§ Email (Opcional - para confirmaciÃ³n automÃ¡tica)</label><input type="email" id="clientEmail" placeholder="tu@email.com" />
            <small style="color:var(--text-light);font-size:.85rem;">Si ingresas tu email, recibirÃ¡s confirmaciÃ³n automÃ¡tica instantÃ¡nea</small>
          </div>
          <div class="form-group"><label>ğŸ“ Comuna</label><select id="comuna" required><option value="">Selecciona tu comuna</option></select></div>
          <div class="form-group"><label>ğŸ  DirecciÃ³n completa</label><input type="text" id="address" required placeholder="Ej: Av. Providencia 1234, Depto 501" />
            <small style="color:var(--text-light);font-size:.85rem;">Calle, nÃºmero, depto/casa (si aplica)</small>
          </div>
          <div class="form-group">
            <label>ğŸ“… Fecha de la visita</label>
            <p id="availableDaysInfo" style="font-size:.9rem;color:var(--text-light);margin-bottom:8px;"></p>
            <input type="date" id="visitDate" required />
          </div>
          <div class="form-group"><label>ğŸ• Horario disponible</label><div id="timeSlots" class="time-grid"></div></div>
          <div class="form-group"><label>ğŸ’¬ Motivo de la consulta</label><textarea id="reason" rows="4" placeholder="Describe brevemente el motivo de la visita veterinaria"></textarea></div>
          <button type="submit" class="primary">âœ¨ Solicitar Visita</button>
        </form>
      </div>
    </div>

    <!-- TAB: CITAS y ADMIN (omitido aquÃ­ por brevedad; se mantiene igual al original) -->
    <div id="citas" class="tab-content"></div>
    <div id="admin" class="tab-content"></div>
  </div>

  <script>
    // =============================
    // Config y defaults
    // =============================
    const defaultConfig = {
      comunas: ['Santiago','Providencia','Las Condes','Vitacura','Ã‘uÃ±oa','La Reina'],
      schedules: [ {start:'09:00', end:'13:00', duration:60}, {start:'14:00', end:'18:00', duration:60} ],
      instagram: 'https://instagram.com/',
      password: 'admin123',
      whatsappNumber: '56995409035',
      email: '',
      workingDays: [1,2,3,4,5],
      emailjs: { publicKey:'', serviceId:'', templateIdVet:'', templateIdClient:'' }
    };

    let isAuthenticated = false;
    let clientAccessCode = null;

    function getConfig(){
      try {
        const stored = JSON.parse(localStorage.getItem('vetConfig'));
        return stored ?? defaultConfig;
      } catch(e){
        return defaultConfig;
      }
    }
    function saveConfig(cfg){ localStorage.setItem('vetConfig', JSON.stringify(cfg)); }
    function initConfig(){ if(!localStorage.getItem('vetConfig')) localStorage.setItem('vetConfig', JSON.stringify(defaultConfig)); }

    function switchTab(tab){
      if(tab==='admin' && !isAuthenticated){ alert('ğŸ”’ Requiere autenticaciÃ³n'); return; }
      document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
      document.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
      const names=['servicios','agendar','citas','admin']; const idx=names.indexOf(tab);
      if(idx>-1) document.querySelectorAll('.tab')[idx].classList.add('active');
      document.getElementById(tab).classList.add('active');
      if(tab==='agendar'){ showAvailableDays(); if(document.getElementById('visitDate').value) generateTimeSlots(); }
    }

    function showAvailableDays(){
      const cfg=getConfig();
      const workingDays = cfg.workingDays || [1,2,3,4,5];
      const dayNames=['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];
      const txt=workingDays.map(d=>dayNames[d]).join(', ');
      const el=document.getElementById('availableDaysInfo'); if(el) el.textContent = `DÃ­as disponibles: ${txt}`;
    }

    function loadComunasSelect(){
      const cfg=getConfig();
      const sel=document.getElementById('comuna');
      sel.innerHTML = '<option value="">Selecciona tu comuna</option>' + cfg.comunas.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    function getBookedSlots(date){
      const appointments = JSON.parse(localStorage.getItem('appointments')) || [];
      return appointments.filter(a=>a.date===date).map(a=>a.time);
    }

    function generateTimeSlots(){
      const cfg=getConfig();
      const date=document.getElementById('visitDate').value;
      const container=document.getElementById('timeSlots');
      if(!date){ container.innerHTML='<p style="text-align:center;color:var(--text-light);">Primero selecciona una fecha</p>'; return; }
      const schedules = Array.isArray(cfg.schedules) ? cfg.schedules : [];
      if(!schedules.length){ container.innerHTML='<p style="text-align:center;color:var(--text-light);">No hay horarios configurados. Configura tus horarios en Config.</p>'; return; }
      const booked=getBookedSlots(date);
      const slots=[];
      schedules.forEach(s=>{
        const [sh, sm]=s.start.split(':').map(Number);
        const [eh, em]=s.end.split(':').map(Number);
        let cur=sh*60+sm; const end=eh*60+em;
        while(cur + s.duration <= end){
          const h=String(Math.floor(cur/60)).padStart(2,'0');
          const m=String(cur%60).padStart(2,'0');
          const t=`${h}:${m}`; const available=!booked.includes(t);
          slots.push({time:t, available}); cur += s.duration;
        }
      });
      container.innerHTML = slots.map(slot => `
        <div class="time-slot ${!slot.available?'unavailable':''}" ${slot.available?`onclick="selectTime(this,'${slot.time}')"`:''} data-time="${slot.time}">
          ${slot.time}
        </div>`).join('');
    }

    function selectTime(el, time){
      document.querySelectorAll('.time-slot').forEach(s=>s.classList.remove('selected'));
      el.classList.add('selected');
      el.dataset.selected='true';
    }

    document.getElementById('visitDate').min = new Date().toISOString().split('T')[0];
    document.getElementById('visitDate').addEventListener('change', function(){
      const d=new Date(this.value+'T00:00:00');
      const dow=d.getDay();
      const cfg=getConfig();
      const wd=cfg.workingDays || [1,2,3,4,5];
      if(!wd.includes(dow)){
        const names=['domingo','lunes','martes','miÃ©rcoles','jueves','viernes','sÃ¡bado'];
        alert(`âš ï¸ Lo sentimos, no atendemos los ${names[dow]}s.

DÃ­as disponibles: ${wd.map(x=>names[x]).join(', ')}`);
        this.value=''; document.getElementById('timeSlots').innerHTML=''; return;
      }
      generateTimeSlots();
    });

    document.getElementById('appointmentForm').addEventListener('submit', function(e){
      e.preventDefault();
      const selected=document.querySelector('.time-slot.selected');
      if(!selected){ alert('âš ï¸ Por favor selecciona un horario'); return; }
      const appointment={
        id: Date.now(),
        ownerName: document.getElementById('ownerName').value,
        petName: document.getElementById('petName').value,
        phone: document.getElementById('phone').value,
        clientEmail: document.getElementById('clientEmail').value.trim(),
        comuna: document.getElementById('comuna').value,
        address: document.getElementById('address').value,
        date: document.getElementById('visitDate').value,
        time: selected.dataset.time,
        reason: document.getElementById('reason').value,
        status: 'Pendiente',
        accessCode: (function(){ const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789'; let r=''; for(let i=0;i<6;i++) r+=c[Math.floor(Math.random()*c.length)]; return r; })()
      };
      const a = JSON.parse(localStorage.getItem('appointments')) || [];
      a.push(appointment); localStorage.setItem('appointments', JSON.stringify(a));

      const success=document.createElement('div'); success.className='success-message';
      success.innerHTML = `âœ… <strong>Â¡Solicitud enviada con Ã©xito!</strong><br>
      Tu visita ha sido agendada para el ${new Date(appointment.date+'T00:00:00').toLocaleDateString('es-CL',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} a las ${appointment.time}.<br><br>
      <div style="background:#fff;color:var(--primary-dark);padding:15px;border-radius:10px;margin:15px 0;border:3px dashed var(--primary);">
      ğŸ”‘ <strong>CÃ“DIGO DE TU CITA: ${appointment.accessCode}</strong><br>
      <small style="color:var(--accent);">âš ï¸ GUARDA ESTE CÃ“DIGO - Lo necesitarÃ¡s para ver y cancelar tu cita</small></div>`;
      this.insertAdjacentElement('beforebegin', success);
      this.reset(); document.getElementById('timeSlots').innerHTML='';
      setTimeout(()=>success.remove(), 10000);
    });

    function updateContactDisplay(){
      const cfg=getConfig();
      const w=document.getElementById('whatsappDisplay');
      if(cfg.whatsappNumber){ const n=cfg.whatsappNumber; w.textContent = `+(${n.slice(0,2)}) ${n.slice(2,3)} ${n.slice(3,7)} ${n.slice(7)}`; }
      const e=document.getElementById('emailDisplay'); if(cfg.email) e.textContent = cfg.email;
    }

    // Bootstrap
    initConfig();
    loadComunasSelect();
    const cfg=getConfig();
    document.getElementById('instagramLink').href = cfg.instagram || '#';
    updateContactDisplay();
  </script>
</body>
</html>
